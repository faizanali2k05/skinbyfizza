// ============================================
// FIRESTORE SECURITY RULES
// SkinByFizza Application - Production Ready
// ============================================
//
// Rules Strategy:
// 1. Users can only read/write their own data
// 2. Admins (role == 'admin') can read/write everything
// 3. Procedures are publicly readable
// 4. Appointments: users see own, admins see all
// 5. Conversations: participants + admins only
// 6. Messages: conversation participants + admins only
// 7. Notifications: user sees only their own
// 8. FAQs: publicly readable
//
// All timestamps handled server-side
// No external API access needed (Spark plan safe)
//
// ============================================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== Users Collection ====================
    // users/{uid}
    // Each user has a document with their profile
    match /users/{uid} {
      allow read: if request.auth.uid == uid || isAdmin(request.auth.uid);
      allow create: if request.auth.uid == uid && canCreateUser(request.resource.data);
      allow update: if request.auth.uid == uid || isAdmin(request.auth.uid);
      allow delete: if isAdmin(request.auth.uid);
    }

    // ==================== Procedures Collection ====================
    // procedures/{procedureId}
    // Public read for all authenticated users
    // Only admins can create/edit/delete
    match /procedures/{procedureId} {
      allow read: if request.auth != null;
      allow create: if isAdmin(request.auth.uid);
      allow update: if isAdmin(request.auth.uid);
      allow delete: if isAdmin(request.auth.uid);
    }

    // ==================== Appointments Collection ====================
    // appointments/{appointmentId}
    // Users see only their own appointments
    // Admins see all appointments
    match /appointments/{appointmentId} {
      allow read: if request.auth.uid == resource.data.userId || 
                     isAdmin(request.auth.uid);
      allow create: if request.auth.uid == request.resource.data.userId && 
                       validateAppointmentCreate();
      allow update: if isAdmin(request.auth.uid) || 
                       (request.auth.uid == resource.data.userId && 
                        validateAppointmentUserUpdate());
      allow delete: if isAdmin(request.auth.uid);
    }

    // ==================== Conversations Collection ====================
    // conversations/{conversationId}
    // conversations/{conversationId}/messages/{messageId}
    match /conversations/{conversationId} {
      // Read: only participants or admin
      allow read: if (request.auth.uid == resource.data.userId ||
                      request.auth.uid == resource.data.adminId ||
                      isAdmin(request.auth.uid));
      
      // Create: authenticated users
      allow create: if request.auth != null && validateConversationCreate();
      
      // Update: only participants or admin
      allow update: if (request.auth.uid == resource.data.userId ||
                        request.auth.uid == resource.data.adminId ||
                        isAdmin(request.auth.uid));
      
      // Delete: admin only
      allow delete: if isAdmin(request.auth.uid);

      // ===== Messages Subcollection =====
      match /messages/{messageId} {
        // Read: only conversation participants or admin
        allow read: if (request.auth.uid == get(/databases/$(database)/documents/conversations/$(conversationId)).data.userId ||
                        request.auth.uid == get(/databases/$(database)/documents/conversations/$(conversationId)).data.adminId ||
                        isAdmin(request.auth.uid));
        
        // Create: authenticated users, valid message data
        allow create: if request.auth != null && validateMessageCreate();
        
        // Update: message sender or admin (for moderation)
        allow update: if request.auth.uid == resource.data.senderId || 
                         isAdmin(request.auth.uid);
        
        // Delete: message sender or admin
        allow delete: if request.auth.uid == resource.data.senderId || 
                         isAdmin(request.auth.uid);
      }
    }

    // ==================== Notifications Collection ====================
    // notifications/{notificationId}
    // Users can only see their own notifications
    // System can create notifications
    match /notifications/{notificationId} {
      allow read: if request.auth.uid == resource.data.userId;
      allow create: if request.auth != null;
      allow update: if request.auth.uid == resource.data.userId && 
                       canUpdateNotification(request.resource.data, resource.data);
      allow delete: if request.auth.uid == resource.data.userId || 
                       isAdmin(request.auth.uid);
    }

    // ==================== FAQs Collection ====================
    // faqs/{faqId}
    // Public read for all authenticated users
    // Only admins can create/edit/delete
    match /faqs/{faqId} {
      allow read: if request.auth != null;
      allow create: if isAdmin(request.auth.uid);
      allow update: if isAdmin(request.auth.uid);
      allow delete: if isAdmin(request.auth.uid);
    }

    // ==================== Helper Functions ====================

    // Check if user is admin
    function isAdmin(uid) {
      return uid != null && 
             get(/databases/$(database)/documents/users/$(uid)).data.role == 'admin';
    }

    // Validate user creation data
    function canCreateUser(data) {
      return data.keys().hasAll(['name', 'email', 'phone']) &&
             data.name is string && data.name.size() > 0 &&
             data.email is string && data.email.size() > 5 &&
             data.phone is string &&
             data.role in ['user', 'admin'] &&
             data.photoUrl is string;
    }

    // Validate appointment on create
    function validateAppointmentCreate() {
      return request.resource.data.keys().hasAll([
        'userId', 'procedureId', 'procedureName', 
        'appointmentDate', 'appointmentTime', 'status'
      ]) &&
      request.resource.data.appointmentDate.matches('^\\d{4}-\\d{2}-\\d{2}$') &&
      request.resource.data.appointmentTime.matches('^\\d{2}:\\d{2}$') &&
      request.resource.data.status in ['booked', 'confirmed', 'completed', 'cancelled'];
    }

    // Validate appointment update by user (only notes and time before confirmation)
    function validateAppointmentUserUpdate() {
      return (request.resource.data.notes is string || 
              request.resource.data.appointmentTime is string) &&
             request.resource.data.userId == resource.data.userId &&
             request.resource.data.status == resource.data.status;
    }

    // Validate conversation creation
    function validateConversationCreate() {
      return request.resource.data.keys().hasAll(['userId', 'adminId']) &&
             request.resource.data.userId is string &&
             request.resource.data.adminId is string;
    }

    // Validate message creation
    function validateMessageCreate() {
      return request.resource.data.keys().hasAll(['senderId', 'senderName', 'senderRole', 'text']) &&
             request.resource.data.senderId == request.auth.uid &&
             request.resource.data.text is string &&
             request.resource.data.text.size() > 0 &&
             request.resource.data.text.size() < 5000 &&
             request.resource.data.senderRole in ['user', 'admin'];
    }

    // Can update notification (only isRead field)
    function canUpdateNotification(newData, oldData) {
      let updated = newData.diff(oldData).affectedKeys();
      return updated.hasOnly(['isRead']) && newData.isRead is bool;
    }
  }
}

// ============================================
// REQUIRED COMPOSITE INDEXES
// Create these in Firebase Console
// ============================================
//
// Index 1: Appointments by User + Date
// Collection: appointments
// Fields: userId (Asc), createdAt (Desc)
// Purpose: Query user's appointments efficiently
//
// Index 2: Appointments by Status + Date
// Collection: appointments
// Fields: status (Asc), createdAt (Desc)
// Purpose: Admin panel - filter by status
//
// Index 3: Notifications by User + Date
// Collection: notifications
// Fields: userId (Asc), createdAt (Desc)
// Purpose: Show user's latest notifications
//
// Index 4: Conversations by User + Update
// Collection: conversations
// Fields: userId (Asc), updatedAt (Desc)
// Purpose: User's conversations sorted by recent
//
// Index 5: Conversations by Admin + Update
// Collection: conversations
// Fields: adminId (Asc), updatedAt (Desc)
// Purpose: Admin's conversations sorted by recent
//
// Note: Firebase will auto-prompt you to create
// these when you run queries that require them.
//
// ============================================

    // ===== APPOINTMENTS COLLECTION =====
    match /appointments/{appointmentId} {
      // Users see their own appointments; admin sees all
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      // Users can create their own appointments
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      // Users can update their own; admin can update any
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      // Admin only delete
      allow delete: if isAdmin();
    }

    // ===== NOTIFICATIONS COLLECTION =====
    match /notifications/{notificationId} {
      // Users see their own notifications
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      // Can create if for current user or admin
      allow create: if isAuthenticated() && 
                       (request.resource.data.userId == request.auth.uid || isAdmin());
      // Users can update own (mark read); admin can update any
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      // Admin only delete
      allow delete: if isAdmin();
    }

    // ===== FAQS COLLECTION =====
    match /faqs/{faqId} {
      // All authenticated users can read FAQs
      allow read: if isAuthenticated();
      // Only admin can write
      allow write: if isAdmin();
    }

    // ===== AI CHAT MESSAGES COLLECTION =====
    match /ai_chat_messages/{msgId} {
      // Users see their own messages
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      // Users can send messages
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      // Users can update own; admin can manage
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      // Admin only delete
      allow delete: if isAdmin();
    }

    // ===== CONVERSATIONS COLLECTION =====
    match /conversations/{conversationId} {
      // Participants (user or doctor/admin) can read conversation
      allow read: if isConversationParticipant(conversationId);
      // Authenticated users can create
      allow create: if isAuthenticated();
      // Participants or admin can update
      allow update: if isConversationParticipant(conversationId);
      // Admin only delete
      allow delete: if isAdmin();
      
      // Messages subcollection
      match /messages/{messageId} {
        // Participants can read/write messages
        allow read: if isConversationParticipant(conversationId);
        allow create: if isAuthenticated() && 
                         (request.resource.data.senderId == request.auth.uid);
        allow update: if isAuthenticated() && 
                         (resource.data.senderId == request.auth.uid || isAdmin());
        allow delete: if isAdmin();
      }
    }
  }
}